{% extends 'base.html' %}

{% block content %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />

    <div class="container">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="caregiver-select">Caregiver:</label>
                <select id="caregiver-select" class="form-control" multiple>
                    {% for caregiver in caregivers %}
                        <option value="{{ caregiver.id }}">{{ caregiver.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="resident-select">Resident:</label>
                <select id="resident-select" class="form-control" multiple>
                    {% for resident in residents %}
                        <option value="{{ resident.id }}">{{ resident.first_name }} {{ resident.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="care-home-select">Care Home:</label>
                <select id="care-home-select" class="form-control" multiple>
                    {% for care_home in care_homes %}
                        <option value="{{ care_home.id }}">{{ care_home.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 mt-3">
                <button id="apply-filter" class="btn btn-primary">Apply Filter</button>
            </div>
        </div>
        <div id="calendar"></div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script>
        $(document).ready(function() {
            $('#caregiver-select, #resident-select, #care-home-select').select2();
    
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                    },
                    views: {
                        listMonth: { buttonText: 'List' }
                    },
                    eventDidMount: function(info) {
                        if (info.view.type === 'listMonth') {
                            var editButton = $('<button>', {
                                text: 'Edit',
                                class: 'fc-button fc-button-primary fc-button-tiny',
                                css: {
                                    'font-size': '0.7em',
                                    'padding': '2px 5px',
                                    'margin-left': '5px'
                                },
                                click: function() {
                                    window.location.href = '/services/' + info.event.id + '/update/';
                                }
                            });
    
                            var deleteButton = $('<button>', {
                                text: 'Delete',
                                class: 'fc-button fc-button-primary fc-button-tiny',
                                css: {
                                    'font-size': '0.7em',
                                    'padding': '2px 5px',
                                    'margin-left': '5px',
                                    'background-color': '#dc3545',
                                    'border-color': '#dc3545'
                                },
                                click: function() {
                                    if (confirm('Are you sure you want to delete this service?')) {
                                        window.location.href = '/services/' + info.event.id + '/delete/';
                                    }
                                }
                            });
    
                            $(info.el).find('.fc-list-event-title')
                                .append(editButton)
                                .append(deleteButton);
                        }
                    },
                    events: function(info, successCallback, failureCallback) {
                        var caregivers = $('#caregiver-select').val() || [];
                        var residents = $('#resident-select').val() || [];
                        var careHomes = $('#care-home-select').val() || [];
    
                        $.ajax({
                            url: '{% url "get_events" %}',
                            data: {
                                start: info.startStr,
                                end: info.endStr,
                                caregivers: caregivers.join(','),
                                residents: residents.join(','),
                                care_homes: careHomes.join(','),
                            },
                            success: function(data) {
                                successCallback(data);
                            },
                            error: function(jqXHR, textStatus, errorThrown) {
                                console.error('Failed to fetch events:', textStatus, errorThrown);
                                failureCallback();
                            }
                        });
                    },
                    dayMaxEvents: true,
                });
                calendar.render();
    
                $('#apply-filter').on('click', function() {
                    calendar.refetchEvents();
                });
            } else {
                console.error('Calendar element not found');
            }
        });
    </script>
{% endblock %}