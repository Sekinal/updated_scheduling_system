{% extends 'base.html' %}

{% block content %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        .fc-event-title {
            white-space: pre-line;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 15px; /* Make room for the blue rectangle */
            position: relative; /* For absolute positioning of the rectangle */
        }
        .fc-event-rectangle {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px; /* Adjust this for the thickness of the rectangle */
            background-color: #007bff; /* Blue color, you can adjust as needed */
        }
        .fc-event-blocked {
            background-color: #dc3545;
            border-color: #dc3545;
        }
    </style>

    <div class="container">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="caregiver-select">Caregiver:</label>
                <select id="caregiver-select" class="form-control" multiple>
                    {% for caregiver in caregivers %}
                        <option value="{{ caregiver.id }}">{{ caregiver.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="resident-select">Resident:</label>
                <select id="resident-select" class="form-control" multiple>
                    {% for resident in residents %}
                        <option value="{{ resident.id }}">{{ resident.first_name }} {{ resident.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="care-home-select">Care Home:</label>
                <select id="care-home-select" class="form-control" multiple>
                    {% for care_home in care_homes %}
                        <option value="{{ care_home.id }}">{{ care_home.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 mt-3">
                <button id="apply-filter" class="btn btn-primary">Apply Filter</button>
            </div>
        </div>
        <div id="calendar"></div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script>
        $(document).ready(function() {
            $('#caregiver-select, #resident-select, #care-home-select').select2();
    
            function formatEventTitle(event) {
                var startTime = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                var endTime = new Date(event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return startTime + ' - ' + endTime + '\n' + event.resident;
            }
    
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                    },
                    views: {
                        listMonth: { buttonText: 'List' }
                    },
                    eventContent: function(arg) {
                    if (arg.event.extendedProps.type === 'blocked') {
                        return {
                            html: '<div class="fc-event-main">' + arg.event.title + '</div>'
                        };
                    } else {
                        return {
                            html: '<div class="fc-event-rectangle"></div><div class="fc-event-title">' + arg.event.title + '</div>'
                        };
                    }
                },
                eventClassNames: function(arg) {
                    if (arg.event.extendedProps.type === 'blocked') {
                        return ['fc-event-blocked'];
                    }
                    return [];
                },
                eventDidMount: function(info) {
                    if (info.view.type === 'listMonth') {
                        if (info.event.extendedProps.type !== 'blocked') {
                            var editButton = $('<button>', {
                                text: 'Edit',
                                class: 'fc-button fc-button-primary fc-button-tiny',
                                css: {
                                    'font-size': '0.7em',
                                    'padding': '2px 5px',
                                    'margin-left': '5px'
                                },
                                click: function() {
                                    window.location.href = '/services/' + info.event.id + '/update/';
                                }
                            });

                            var deleteButton = $('<button>', {
                                text: 'Delete',
                                class: 'fc-button fc-button-primary fc-button-tiny',
                                css: {
                                    'font-size': '0.7em',
                                    'padding': '2px 5px',
                                    'margin-left': '5px',
                                    'background-color': '#dc3545',
                                    'border-color': '#dc3545'
                                },
                                click: function() {
                                    if (confirm('Are you sure you want to delete this service?')) {
                                        window.location.href = '/services/' + info.event.id + '/delete/';
                                    }
                                }
                            });

                            $(info.el).find('.fc-list-event-title')
                                .append(editButton)
                                .append(deleteButton);
                        }
                    }
                },
                    events: function(info, successCallback, failureCallback) {
                        var caregivers = $('#caregiver-select').val() || [];
                        var residents = $('#resident-select').val() || [];
                        var careHomes = $('#care-home-select').val() || [];
    
                        $.ajax({
                            url: '{% url "get_events" %}',
                            data: {
                                start: info.startStr,
                                end: info.endStr,
                                caregivers: caregivers.join(','),
                                residents: residents.join(','),
                                care_homes: careHomes.join(','),
                            },
                            success: function(data) {
                            var events = data.map(function(event) {
                                return {
                                    id: event.id,
                                    title: event.type === 'blocked' ? event.title : formatEventTitle(event),
                                    start: event.start,
                                    end: event.end,
                                    allDay: false,
                                    extendedProps: {
                                        type: event.type
                                    }
                                };
                            });
                            successCallback(events);
                        },
                            error: function(jqXHR, textStatus, errorThrown) {
                                console.error('Failed to fetch events:', textStatus, errorThrown);
                                failureCallback();
                            }
                        });
                    },
                    dayMaxEvents: true,
                });
                calendar.render();
    
                $('#apply-filter').on('click', function() {
                    calendar.refetchEvents();
                });
            } else {
                console.error('Calendar element not found');
            }
        });
    </script>
{% endblock %}